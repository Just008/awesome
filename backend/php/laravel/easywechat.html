<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EasyWeChat | Awesome</title>
    <meta name="description" content="多少殷勤全白付，当年戏语误青丝。">
    <link rel="icon" href="/awesome/favicon.ico">
    
    <link rel="preload" href="/awesome/assets/css/0.styles.c7e0f778.css" as="style"><link rel="preload" href="/awesome/assets/js/app.8cf76ae9.js" as="script"><link rel="preload" href="/awesome/assets/js/18.81a7b35a.js" as="script"><link rel="prefetch" href="/awesome/assets/js/10.3075fc80.js"><link rel="prefetch" href="/awesome/assets/js/11.495c26c8.js"><link rel="prefetch" href="/awesome/assets/js/12.6c4cb92a.js"><link rel="prefetch" href="/awesome/assets/js/13.223b913a.js"><link rel="prefetch" href="/awesome/assets/js/14.7c69b723.js"><link rel="prefetch" href="/awesome/assets/js/15.1fc75eaf.js"><link rel="prefetch" href="/awesome/assets/js/16.857c83a6.js"><link rel="prefetch" href="/awesome/assets/js/17.37bad7c1.js"><link rel="prefetch" href="/awesome/assets/js/19.965e5d7a.js"><link rel="prefetch" href="/awesome/assets/js/2.91f3fac3.js"><link rel="prefetch" href="/awesome/assets/js/20.29b17134.js"><link rel="prefetch" href="/awesome/assets/js/21.a9565424.js"><link rel="prefetch" href="/awesome/assets/js/22.4e12257d.js"><link rel="prefetch" href="/awesome/assets/js/23.d4b367e2.js"><link rel="prefetch" href="/awesome/assets/js/24.ed5ea60c.js"><link rel="prefetch" href="/awesome/assets/js/25.4e3cfe7d.js"><link rel="prefetch" href="/awesome/assets/js/26.d82204e3.js"><link rel="prefetch" href="/awesome/assets/js/27.e6d55455.js"><link rel="prefetch" href="/awesome/assets/js/28.f89cccc1.js"><link rel="prefetch" href="/awesome/assets/js/29.6d2602c7.js"><link rel="prefetch" href="/awesome/assets/js/3.293d6317.js"><link rel="prefetch" href="/awesome/assets/js/30.95ee547e.js"><link rel="prefetch" href="/awesome/assets/js/31.4d724ffd.js"><link rel="prefetch" href="/awesome/assets/js/32.83236c87.js"><link rel="prefetch" href="/awesome/assets/js/33.7d7c662a.js"><link rel="prefetch" href="/awesome/assets/js/34.7d0f52fc.js"><link rel="prefetch" href="/awesome/assets/js/35.fed876ed.js"><link rel="prefetch" href="/awesome/assets/js/36.d50d3ce5.js"><link rel="prefetch" href="/awesome/assets/js/37.ff579ca0.js"><link rel="prefetch" href="/awesome/assets/js/38.0a633d1f.js"><link rel="prefetch" href="/awesome/assets/js/39.1fd71fba.js"><link rel="prefetch" href="/awesome/assets/js/4.a1021806.js"><link rel="prefetch" href="/awesome/assets/js/40.b7f2f628.js"><link rel="prefetch" href="/awesome/assets/js/41.bb1c690c.js"><link rel="prefetch" href="/awesome/assets/js/42.848ee583.js"><link rel="prefetch" href="/awesome/assets/js/43.2cbc8dac.js"><link rel="prefetch" href="/awesome/assets/js/44.0d2d1cb1.js"><link rel="prefetch" href="/awesome/assets/js/45.349cafa9.js"><link rel="prefetch" href="/awesome/assets/js/46.7c031c27.js"><link rel="prefetch" href="/awesome/assets/js/47.ba69afb2.js"><link rel="prefetch" href="/awesome/assets/js/48.60e79dc9.js"><link rel="prefetch" href="/awesome/assets/js/49.e23be272.js"><link rel="prefetch" href="/awesome/assets/js/5.d1529520.js"><link rel="prefetch" href="/awesome/assets/js/50.8b2d3a41.js"><link rel="prefetch" href="/awesome/assets/js/51.ca015c29.js"><link rel="prefetch" href="/awesome/assets/js/52.87701b5f.js"><link rel="prefetch" href="/awesome/assets/js/53.ecbdf7fb.js"><link rel="prefetch" href="/awesome/assets/js/54.eea54ab8.js"><link rel="prefetch" href="/awesome/assets/js/55.c6a11cff.js"><link rel="prefetch" href="/awesome/assets/js/56.a9eb8dde.js"><link rel="prefetch" href="/awesome/assets/js/57.135d2e72.js"><link rel="prefetch" href="/awesome/assets/js/58.fa4cccd0.js"><link rel="prefetch" href="/awesome/assets/js/6.1eb05619.js"><link rel="prefetch" href="/awesome/assets/js/7.9181616b.js"><link rel="prefetch" href="/awesome/assets/js/8.c0fe1677.js"><link rel="prefetch" href="/awesome/assets/js/9.f2b6c430.js">
    <link rel="stylesheet" href="/awesome/assets/css/0.styles.c7e0f778.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/awesome/" class="home-link router-link-active"><!----> <span class="site-name">Awesome</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/awesome/" class="nav-link">首页</a></div><div class="nav-item"><a href="/awesome/guide/" class="nav-link">指南</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/web/vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/awesome/web/vue-book/" class="nav-link">Vue Book</a></li></ul></li><li class="dropdown-item"><h4>扩展</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/web/typescript/" class="nav-link">Typescript</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>PHP</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/backend/php/laravel/" class="nav-link router-link-active">Laravel</a></li><li class="dropdown-subitem"><a href="/awesome/backend/php/swoole/" class="nav-link">Swoole</a></li><li class="dropdown-subitem"><a href="/awesome/backend/php/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-subitem"><a href="/awesome/backend/php/nginx/" class="nav-link">Nginx</a></li></ul></li><li class="dropdown-item"><h4>SQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/backend/sql/mysql/" class="nav-link">Mysql</a></li><li class="dropdown-subitem"><a href="/awesome/backend/sql/redis/" class="nav-link">Redis</a></li></ul></li><li class="dropdown-item"><h4>其他</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/backend/other/git.html" class="nav-link">Git</a></li><li class="dropdown-subitem"><a href="/awesome/backend/other/markdown.html" class="nav-link">Markdown</a></li><li class="dropdown-subitem"><a href="/awesome/backend/interview/" class="nav-link">面试宝典</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础知识</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/linux/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/awesome/linux/vim.html" class="nav-link">Vim</a></li><li class="dropdown-subitem"><a href="/awesome/linux/supervisor.html" class="nav-link">Supervisor</a></li><li class="dropdown-subitem"><a href="/awesome/linux/screen.html" class="nav-link">Screen</a></li><li class="dropdown-subitem"><a href="/awesome/linux/bs.html" class="nav-link">Bash 命令</a></li></ul></li><li class="dropdown-item"><h4>运维方向</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/linux/lnmp.html" class="nav-link">LNMP 搭建</a></li><li class="dropdown-subitem"><a href="/awesome/linux/ab.html" class="nav-link">AB 测试工具</a></li><li class="dropdown-subitem"><a href="/awesome/linux/deployer-auto.html" class="nav-link">Deployer</a></li><li class="dropdown-subitem"><a href="/awesome/linux/sentry-auto.html" class="nav-link">Sentry 部署</a></li><li class="dropdown-subitem"><a href="/awesome/linux/sentry-auto-notice-error.html" class="nav-link">Sentry 异常提醒</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/awesome/leetcode/" class="nav-link">Leetcode</a></div> <a href="https://github.com/Just008/awesome" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/awesome/" class="nav-link">首页</a></div><div class="nav-item"><a href="/awesome/guide/" class="nav-link">指南</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/web/vue/" class="nav-link">Vue</a></li><li class="dropdown-subitem"><a href="/awesome/web/vue-book/" class="nav-link">Vue Book</a></li></ul></li><li class="dropdown-item"><h4>扩展</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/web/typescript/" class="nav-link">Typescript</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>PHP</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/backend/php/laravel/" class="nav-link router-link-active">Laravel</a></li><li class="dropdown-subitem"><a href="/awesome/backend/php/swoole/" class="nav-link">Swoole</a></li><li class="dropdown-subitem"><a href="/awesome/backend/php/design-pattern/" class="nav-link">设计模式</a></li><li class="dropdown-subitem"><a href="/awesome/backend/php/nginx/" class="nav-link">Nginx</a></li></ul></li><li class="dropdown-item"><h4>SQL</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/backend/sql/mysql/" class="nav-link">Mysql</a></li><li class="dropdown-subitem"><a href="/awesome/backend/sql/redis/" class="nav-link">Redis</a></li></ul></li><li class="dropdown-item"><h4>其他</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/backend/other/git.html" class="nav-link">Git</a></li><li class="dropdown-subitem"><a href="/awesome/backend/other/markdown.html" class="nav-link">Markdown</a></li><li class="dropdown-subitem"><a href="/awesome/backend/interview/" class="nav-link">面试宝典</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>基础知识</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/linux/docker/" class="nav-link">Docker</a></li><li class="dropdown-subitem"><a href="/awesome/linux/vim.html" class="nav-link">Vim</a></li><li class="dropdown-subitem"><a href="/awesome/linux/supervisor.html" class="nav-link">Supervisor</a></li><li class="dropdown-subitem"><a href="/awesome/linux/screen.html" class="nav-link">Screen</a></li><li class="dropdown-subitem"><a href="/awesome/linux/bs.html" class="nav-link">Bash 命令</a></li></ul></li><li class="dropdown-item"><h4>运维方向</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/awesome/linux/lnmp.html" class="nav-link">LNMP 搭建</a></li><li class="dropdown-subitem"><a href="/awesome/linux/ab.html" class="nav-link">AB 测试工具</a></li><li class="dropdown-subitem"><a href="/awesome/linux/deployer-auto.html" class="nav-link">Deployer</a></li><li class="dropdown-subitem"><a href="/awesome/linux/sentry-auto.html" class="nav-link">Sentry 部署</a></li><li class="dropdown-subitem"><a href="/awesome/linux/sentry-auto-notice-error.html" class="nav-link">Sentry 异常提醒</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/awesome/leetcode/" class="nav-link">Leetcode</a></div> <a href="https://github.com/Just008/awesome" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Laravel 总结</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/awesome/backend/php/laravel/" aria-current="page" class="sidebar-link">简介</a></li><li><a href="/awesome/backend/php/laravel/easywechat.html" aria-current="page" class="active sidebar-link">EasyWeChat</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#laravel-框架" class="sidebar-link">Laravel 框架</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#配置" class="sidebar-link">配置</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#git-自动部署" class="sidebar-link">git 自动部署</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#微信路由" class="sidebar-link">微信路由</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#微信token验证" class="sidebar-link">微信token验证</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#用户信息" class="sidebar-link">用户信息</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#微信支付二维码扫描" class="sidebar-link">微信支付二维码扫描</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#支付宝即时到账" class="sidebar-link">支付宝即时到账</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#微信网页授权" class="sidebar-link">微信网页授权</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#微信jsapi支付" class="sidebar-link">微信JSAPI支付</a></li><li class="sidebar-sub-header"><a href="/awesome/backend/php/laravel/easywechat.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/awesome/backend/php/laravel/permission.html" class="sidebar-link">Laravel-Permission</a></li><li><a href="/awesome/backend/php/laravel/question.html" class="sidebar-link">常见问题总结</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="easywechat"><a href="#easywechat" class="header-anchor">#</a> EasyWeChat</h1> <blockquote><p>EasyWeChat 是一个开源的 微信 非官方 SDK。</p> <p>EasyWeChat 的安装非常简单，因为它是一个标准的 Composer 包，这意味着任何满足下列安装条件的 PHP 项目支持 Composer 都可以使用它。</p></blockquote> <p><img src="http://md.laragh.top/vuepress/easywechat.png" alt="easywechat"></p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>Github 地址： <a href="https://github.com/overtrue/wechat" target="_blank" rel="noopener noreferrer">overtrue/wechat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> [不建议使用框架的包]</p> <p><code>composer require overtrue/wechat:~4.0 -vvv</code></p> <h2 id="laravel-框架"><a href="#laravel-框架" class="header-anchor">#</a> Laravel 框架</h2> <p>Laravel Framework 5.5.28</p> <h2 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h2> <p>看文档，ENV 配置</p> <div class="language-ENV extra-class"><pre class="language-text"><code># 基本信息
WECHAT_APPID=wxeba163c4xxxxx
WECHAT_SECRET=216d04f683afe852d84eded9xxxxx
WECHAT_TOKEN=60166ea337d0d3d8f9b6be41xxxxx
WECHAT_AES_KEY=a4hrTSdjWy8SPvxaVPqiFw2o9ZYTegLlbQzxxxxx
# 支付
WECHAT_PAYMENT_MERCHANT_ID=1300xxxxx
WECHAT_PAYMENT_KEY=123skijik3412934lkllxxxxx
WECHAT_PAYMENT_CERT_PATH=/path/apiclient_cert.pem
WECHAT_PAYMENT_KEY_PATH=/path/apiclient_key.pem
</code></pre></div><h2 id="git-自动部署"><a href="#git-自动部署" class="header-anchor">#</a> git 自动部署</h2> <blockquote><p><a href="https://aotu.io/notes/2017/04/10/githooks/" target="_blank" rel="noopener noreferrer">用 Git 钩子进行简单自动部署<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="微信路由"><a href="#微信路由" class="header-anchor">#</a> 微信路由</h2> <div class="language-\routes\web.php extra-class"><pre class="language-text"><code>//微信token验证
Route::any('/wechat', 'Wechat\WechatController@serve');
//根据openId获取用户信息
Route::get('/wx/users/{openId}', 'Wechat\WxUsersController@user');
</code></pre></div><h2 id="微信token验证"><a href="#微信token验证" class="header-anchor">#</a> 微信token验证</h2> <p>project\app\Http\Controllers\Wechat\WechatController.php</p> <div class="language-php extra-class"><pre class="language-php"><code>\app\Http\Controllers\Wechat\WechatController<span class="token operator">.</span><span class="token class-name type-declaration">php</span>
$ php artisan make<span class="token punctuation">:</span>controller Wechat<span class="token operator">/</span>WechatController <span class="token comment">#新建控制器</span>

project\app\Http\Controllers\Wechat\WechatController<span class="token operator">.</span>php

<span class="token comment">/**
 * 处理微信的请求消息
 *
 * @return string
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$wechat</span> <span class="token operator">=</span> <span class="token function">app</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wechat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$userApi</span> <span class="token operator">=</span> <span class="token variable">$wechat</span><span class="token operator">-&gt;</span><span class="token property">user</span><span class="token punctuation">;</span>
    <span class="token variable">$wechat</span><span class="token operator">-&gt;</span><span class="token property">server</span><span class="token operator">-&gt;</span><span class="token function">setMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$userApi</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token operator">-&gt;</span><span class="token property">MsgType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'event'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token operator">-&gt;</span><span class="token property">Event</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string double-quoted-string">&quot;欢迎关注！&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token operator">-&gt;</span><span class="token property">Event</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'unsubscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'取消订阅'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> <span class="token string double-quoted-string">&quot;取消订阅！&quot;</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到事件消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'text'</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$message</span><span class="token operator">-&gt;</span><span class="token property">Content</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> <span class="token string single-quoted-string">'你好 '</span><span class="token operator">.</span><span class="token variable">$userApi</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token operator">-&gt;</span><span class="token property">FromUserName</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token property">nickname</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'image'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到图片消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'voice'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到语音消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'video'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到视频消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'location'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到坐标消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string single-quoted-string">'link'</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到链接消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// ... 其它消息</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string single-quoted-string">'收到其它消息'</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$wechat</span><span class="token operator">-&gt;</span><span class="token property">server</span><span class="token operator">-&gt;</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><a href="https://easywechat.org/zh-cn/docs/server.html#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener noreferrer">EasyWechat 消息处理基本使用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
\Log::info('取消订阅');  调试时可以用 tail 动态查看日志，例如</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token string">''</span> <span class="token operator">&gt;</span> /path/project/storage/logs/laravel.log <span class="token operator">&amp;&amp;</span> <span class="token function">tail</span> -n <span class="token number">20</span> -f /path/project/storage/logs/laravel.log
<span class="token punctuation">[</span><span class="token number">2017</span>-06-05 <span class="token number">17</span>:20:07<span class="token punctuation">]</span> local.INFO: 取消订阅
</code></pre></div><h2 id="用户信息"><a href="#用户信息" class="header-anchor">#</a> 用户信息</h2> <p>project\app\Http\Controllers\Wechat\WxUsersController.php</p> <div class="language-php extra-class"><pre class="language-php"><code>$ php artisan make:controller Wechat/WxUsersController #微信用户管理控制器

project\app\Http\Controllers\Wechat\WxUsersController.php

<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers<span class="token punctuation">\</span>Wechat</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">EasyWeChat<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Application</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">WxUsersController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$wechat</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Application</span> <span class="token variable">$wechat</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span> <span class="token operator">=</span> <span class="token variable">$wechat</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//根据 openid 获取用户信息</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">user</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span><span class="token operator">-&gt;</span><span class="token property">user</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre></div><h2 id="微信支付二维码扫描"><a href="#微信支付二维码扫描" class="header-anchor">#</a> 微信支付二维码扫描</h2> <p>虽然文档上面有这篇<a href="https://laravel-china.org/topics/3146/tutorial-based-on-the-laravel51-version-of-wechat-lts-development" target="_blank" rel="noopener noreferrer">【教程】基于 Laravel5.1 LTS 版的微信开发<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然而作者还是有很多没说出来的坑!!!(可能是我比较菜的原因)</p> <ul><li>首先装个二维码组件 <a href="https://www.simplesoftware.io/docs/simple-qrcode/zh#docs-configuration" target="_blank" rel="noopener noreferrer">Simple QrCode<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>新建控制器 <code>$ php artisan make:controller WxpayController</code>
project\app\Http\Controllers\WxpayController.php</li></ul> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">EasyWeChat<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Application</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">EasyWeChat<span class="token punctuation">\</span>Payment<span class="token punctuation">\</span>Order</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">SimpleSoftwareIO<span class="token punctuation">\</span>QrCode<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>QrCode</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">WxpayController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$wechat</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Application</span> <span class="token variable">$wechat</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//依赖注入</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span> <span class="token operator">=</span> <span class="token variable">$wechat</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//生成订单</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">order</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'trade_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'NATIVE'</span><span class="token punctuation">,</span> <span class="token comment">// JSAPI，NATIVE，APP...</span>
            <span class="token string single-quoted-string">'body'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'iPad mini 16G 白色'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'detail'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'iPad mini 16G 白色'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'1217752501201407033233368018'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'total_fee'</span> <span class="token operator">=&gt;</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'money'</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 单位：分</span>
            <span class="token string single-quoted-string">'notify_url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'http://xxx/notify'</span><span class="token punctuation">,</span> <span class="token comment">// 支付结果通知网址，如果不设置则会使用配置里的默认地址</span>
            <span class="token comment">//'openid' =&gt; '当前用户的 openid', // trade_type=JSAPI，此参数必传，用户在商户appid下的唯一标识，</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$payment</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span><span class="token operator">-&gt;</span><span class="token property">payment</span><span class="token punctuation">;</span>
        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$payment</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//生成订单时可以打印看看有什么错没</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">return_code</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'SUCCESS'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">result_code</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'SUCCESS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$ajax_data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'html'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token class-name static-context">QrCode</span><span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'price'</span> <span class="token operator">=&gt;</span> <span class="token variable">$attributes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'total_fee'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token variable">$ajax_data</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;出错了。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 出错就说出来，不然还能怎样？</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre></div><blockquote><p>关于<code>trade_type</code>看官方文档熟悉下参数的用途 <a href="https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_1" target="_blank" rel="noopener noreferrer">统一下单<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 看下请求参数，里面指出了用户标识<code>openid</code>不是必传，所以我们得选 <code>NATIVE</code> 而不是<code>JSAPI</code>,我还很纠结这<code>openid</code>怎么获取，没想到这个其实是<code>JSAPI</code>时才需要传的参数，所以还是得多看下官方文档。</p></blockquote> <blockquote><p>关于<code>total_fee</code>参数，这个是以分为单位，所以需要乘100，不然传0.01时会报错，取出来是自然要除以100了。</p></blockquote> <blockquote><p>关于返回的<code>$ajax_data</code>数据，上面那篇教程里面有个<code>$data-&gt;order_guid,$data-&gt;price</code> 这2个数据其实是他在别的地方定义的，也就是返回唯一订单号跟价钱，传不传无所谓，只要有二维码就行了，不用纠结他是哪来的。</p></blockquote> <p>接下来看回调，因为是扫码支付，需要在服务器上做个标志，通过js轮询这个标志，所以我们要建个支付的订单表，不然前台扫码支付后页面不会做任何操作。</p> <p>建表</p> <blockquote><p><code>$ php artisan make:migration create_pay_users_table</code> <code>$ php artisan make:migration create_pay_orders_table</code></p></blockquote> <div class="language-php extra-class"><pre class="language-php"><code>project\database\migrations\<span class="token number">2017_06_13_180443</span>_create_pay_users_table<span class="token operator">.</span>php

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Schema</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Blueprint</span> <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'nickname'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户昵称'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'avatar'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户头像'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_type'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'支付方式'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Schema</span><span class="token operator">::</span><span class="token function">dropIfExists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

project\database\migrations\<span class="token number">2017_06_13_181502</span>_create_pay_orders_table<span class="token operator">.</span>php

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">up</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Schema</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_orders'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name type-declaration">Blueprint</span> <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'阿里账号或微信open_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'p_id'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'产品id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_guid'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'订单号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_money'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'支付金额'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_status'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'支付状态'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token keyword type-declaration">string</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_type'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'支付类型'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'paid_at'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">comment</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'支付时间'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$table</span><span class="token operator">-&gt;</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">down</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Schema</span><span class="token operator">::</span><span class="token function">dropIfExists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay_orders'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

$ php artisan migrate
</code></pre></div><p>以下是完整的<code>WxPayController</code>的代码,操作用户信息的代码可用可不用，我是项目需要</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Controllers</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">EasyWeChat<span class="token punctuation">\</span>Foundation<span class="token punctuation">\</span>Application</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">EasyWeChat<span class="token punctuation">\</span>Payment<span class="token punctuation">\</span>Order</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">SimpleSoftwareIO<span class="token punctuation">\</span>QrCode<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>QrCode</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Log</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PayUser</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PayOrder</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">WxpayController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$wechat</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$payment</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Application</span> <span class="token variable">$wechat</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//依赖注入</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span> <span class="token operator">=</span> <span class="token variable">$wechat</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">payment</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span><span class="token operator">-&gt;</span><span class="token property">payment</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//生成订单</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">order</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$out_trade_no</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'xxx'</span><span class="token operator">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;YmdHis&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$attributes</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'trade_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'NATIVE'</span><span class="token punctuation">,</span> <span class="token comment">// JSAPI，NATIVE，APP...</span>
            <span class="token string single-quoted-string">'body'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'iPad mini 16G 白色'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'detail'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'iPad mini 16G 白色'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'out_trade_no'</span> <span class="token operator">=&gt;</span> <span class="token variable">$out_trade_no</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'total_fee'</span> <span class="token operator">=&gt;</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'money'</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 单位：分</span>
            <span class="token string single-quoted-string">'notify_url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'http://m.lidetang.org/wechat/pc/notify'</span><span class="token punctuation">,</span> <span class="token comment">// 支付结果通知网址，如果不设置则会使用配置里的默认地址</span>
            <span class="token comment">//'openid' =&gt; '当前用户的 openid', // trade_type=JSAPI，此参数必传，用户在商户appid下的唯一标识，</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token variable">$attributes</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">payment</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果微信订单生成成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">return_code</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'SUCCESS'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token property">result_code</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'SUCCESS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//创建未支付订单信息</span>
            <span class="token variable">$order_info</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'user_id'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'no_id'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'p_id'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'5'</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'order_guid'</span> <span class="token operator">=&gt;</span> <span class="token variable">$out_trade_no</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'pay_money'</span> <span class="token operator">=&gt;</span> <span class="token variable">$attributes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'total_fee'</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'order_status'</span> <span class="token operator">=&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'pay_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'wechat'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'未支付订单详情：'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$order_info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//创建未支付订单</span>
            <span class="token class-name static-context">PayOrder</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$order_info</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//ajax返回数据</span>
            <span class="token variable">$ajax_data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'html'</span> <span class="token operator">=&gt;</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token class-name static-context">QrCode</span><span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code_url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'order_guid'</span> <span class="token operator">=&gt;</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'order_guid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'price'</span> <span class="token operator">=&gt;</span> <span class="token variable">$order_info</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'pay_money'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

            <span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token variable">$ajax_data</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">&quot;出错了。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 出错就说出来，不然还能怎样？</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//支付回调函数</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">notifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'进入回调'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">payment</span><span class="token operator">-&gt;</span><span class="token function">handleNotify</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$notify</span><span class="token punctuation">,</span> <span class="token variable">$successful</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//查数据库看这个订单是否存在</span>
            <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token class-name static-context">PayOrder</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_guid'</span><span class="token punctuation">,</span> <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">out_trade_no</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'订单号'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">out_trade_no</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果订单不存在</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$order</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'订单没有存在'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'回调中未支付订单信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 告诉微信，我已经处理完了，订单没找到，别再通知我了</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果订单存在</span>
                <span class="token comment">// 检查订单是否已经更新过支付状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">paid_at</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 假设订单字段“支付时间”不为空代表已经支付</span>
                    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'回调中未支付订单信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'订单存在支付时间:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">paid_at</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 已经支付成功了就不再更新了</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$userService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">wechat</span><span class="token operator">-&gt;</span><span class="token property">user</span><span class="token punctuation">;</span>
            <span class="token comment">// 用户是否支付成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$successful</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'进入支付'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">/*
                 * 记录用户信息
                 */</span>
                <span class="token variable">$user_info</span> <span class="token operator">=</span> <span class="token variable">$userService</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">openid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//查找支付用户信息</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'查找支付用户信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token class-name static-context">PayUser</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'user_id'</span><span class="token punctuation">,</span> <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">openid</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//如果没有这个用户</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'没有这个用户的信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//如果有订阅</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">subscribe</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户有订阅:'</span><span class="token operator">.</span><span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">subscribe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                            <span class="token string single-quoted-string">'user_id'</span> <span class="token operator">=&gt;</span> <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">openid</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'nickname'</span> <span class="token operator">=&gt;</span> <span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">nickname</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'avatar'</span> <span class="token operator">=&gt;</span> <span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">headimgurl</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'pay_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'wechat'</span><span class="token punctuation">,</span>
                        <span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">//创建用户信息</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'订阅用户的信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name static-context">PayUser</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//否则设置默认信息</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户没有订阅：'</span><span class="token operator">.</span><span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">subscribe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                            <span class="token string single-quoted-string">'user_id'</span> <span class="token operator">=&gt;</span> <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">openid</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'nickname'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'爱心人士'</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'avatar'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'/images/avatar/pay.jpg'</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'pay_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'wechat'</span><span class="token punctuation">,</span>
                        <span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//创建默认用户信息</span>
                        <span class="token class-name static-context">PayUser</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//如果有这个用户</span>
                    <span class="token comment">//查看订阅情况</span>
                    <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'已存在该用户信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">subscribe</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//更新用户信息</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户有订阅'</span><span class="token operator">.</span><span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">subscribe</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">nickname</span> <span class="token operator">=</span> <span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">nickname</span><span class="token punctuation">;</span>
                        <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token property">avatar</span> <span class="token operator">=</span> <span class="token variable">$user_info</span><span class="token operator">-&gt;</span><span class="token property">headimgurl</span><span class="token punctuation">;</span>
                        <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'更新用户信息'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//更新未支付订单信息，标志order_status为1，已支付</span>
                <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'用户信息处理完毕'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">user_id</span> <span class="token operator">=</span> <span class="token variable">$notify</span><span class="token operator">-&gt;</span><span class="token property">openid</span><span class="token punctuation">;</span>
                <span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">paid_at</span> <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">order_status</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token property">order_status</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$order</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 保存订单</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'更新订单支付状态'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 返回处理完成</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name static-context">Log</span><span class="token operator">::</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'回调结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">getOrderStatus</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$pay_status</span> <span class="token operator">=</span> <span class="token class-name static-context">PayOrder</span><span class="token operator">::</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_guid'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_guid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'order_status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'pay_status'</span> <span class="token operator">=&gt;</span> <span class="token variable">$pay_status</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</span></code></pre></div><p>附加路由</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//支付详情页</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/pay_details/{id}'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'HomeController@pay_details'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//wechat QrCode Scan pay</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/wechat/pay'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'WxpayController@order'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/wechat/pc/notify'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'WxpayController@notifyUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/wechat/orderStatus'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'WxpayController@getOrderStatus'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//支付详情</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">pay_details</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">view</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pay.pay_details'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://gist.github.com/wploey/9e4ebeadd4c31e7e6f645156aec28ba9" target="_blank" rel="noopener noreferrer">pay.pay_details.blade.php 代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>效果图
<img src="http://oqlezeown.bkt.clouddn.com/qr-scan-pay-preview.png" alt></p> <h2 id="支付宝即时到账"><a href="#支付宝即时到账" class="header-anchor">#</a> 支付宝即时到账</h2> <p><a href="https://github.com/latrell/Alipay" target="_blank" rel="noopener noreferrer">latrell/Alipay<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 安装好了按照文档写上对应代码就可以用了</p> <h2 id="微信网页授权"><a href="#微信网页授权" class="header-anchor">#</a> 微信网页授权</h2> <p>按照 EasyWeChat 文档配置 OAuth2.0</p> <h2 id="微信jsapi支付"><a href="#微信jsapi支付" class="header-anchor">#</a> 微信JSAPI支付</h2> <p>同微信支付二维码扫描差不多，需要根据<code>OAuth2.0</code>获取<code>opendi</code>生成订单</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <blockquote><p><a href="https://easywechat.org/zh-cn/docs/payment.html" target="_blank" rel="noopener noreferrer">EasyWeChat 支付<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://laravel-china.org/topics/3146/tutorial-based-on-the-laravel51-version-of-wechat-lts-development" target="_blank" rel="noopener noreferrer">【教程】基于 Laravel5.1 LTS 版的微信开发<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://blog.csdn.net/amazingdyd/article/details/59483697" target="_blank" rel="noopener noreferrer">Laravel使用EasyWechat，3分钟完成微信APP支付<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
相关资料
<a href="http://www.cnblogs.com/raincedar/p/5653584.html" target="_blank" rel="noopener noreferrer">微信扫码支付模式一和模式二的区别<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Just008/awesome/edit/master/docs/backend/php/laravel/easywechat.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2/26/2019, 1:56:24 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/awesome/backend/php/laravel/" class="prev router-link-active">
          简介
        </a></span> <span class="next"><a href="/awesome/backend/php/laravel/permission.html">
          Laravel-Permission
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/awesome/assets/js/app.8cf76ae9.js" defer></script><script src="/awesome/assets/js/18.81a7b35a.js" defer></script>
  </body>
</html>
